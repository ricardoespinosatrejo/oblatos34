<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usuarios - Caja Oblatos (Funcionando)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { text-align: center; margin-bottom: 30px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; margin-bottom: 10px; }
        .btn-actualizar { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .btn-actualizar:hover { background: #0056b3; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat-card h3 { color: #666; margin-bottom: 10px; font-size: 14px; }
        .stat-card p { font-size: 24px; font-weight: bold; color: #333; }
        .table-container { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: #333; }
        .loading { text-align: center; color: #666; font-style: italic; }
        .error { text-align: center; color: #dc3545; background: #f8d7da; padding: 20px; }
        .no-data { text-align: center; color: #666; padding: 40px; }
        .no-data h3 { margin-bottom: 10px; }
        .puntos-cero { color: #6c757d; }
        .puntos-bajo { color: #dc3545; }
        .puntos-medio { color: #ffc107; }
        .puntos-alto { color: #28a745; }
        .racha-cero { color: #6c757d; }
        .racha-baja { color: #dc3545; }
        .racha-media { color: #ffc107; }
        .racha-alta { color: #28a745; }
        .nunca { color: #6c757d; }
        .hoy { color: #28a745; }
        .reciente { color: #17a2b8; }
        .antiguo { color: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÄ Usuarios Registrados - FUNCIONANDO</h1>
            <p>Caja Oblatos - Base de Datos MySQL con Sistema de Puntos</p>
            <button onclick="cargarUsuarios()" class="btn-actualizar">üîÑ Actualizar Datos</button>
        </header>

        <div class="stats" id="estadisticas">
            <div class="stat-card">
                <h3>‚è≥ Cargando...</h3>
                <p>...</p>
            </div>
        </div>

        <div class="table-container">
            <table id="tabla-usuarios">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Usuario</th>
                        <th>Nombre del Menor</th>
                        <th>Rango de Edad</th>
                        <th>Padre/Madre</th>
                        <th>Email</th>
                        <th>Tel√©fono</th>
                        <th>Puntos</th>
                        <th>Racha</th>
                        <th>√öltima Sesi√≥n</th>
                        <th>Fecha de Registro</th>
                    </tr>
                </thead>
                <tbody id="cuerpo-tabla">
                    <tr>
                        <td colspan="11" class="loading">üîÑ Cargando usuarios...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Cargar datos al iniciar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ P√°gina cargada, iniciando carga de datos...');
            cargarUsuarios();
        });

        async function cargarUsuarios() {
            console.log('üì° Iniciando carga de usuarios...');
            const tbody = document.getElementById('cuerpo-tabla');
            const statsDiv = document.getElementById('estadisticas');
            
            try {
                // Mostrar loading
                tbody.innerHTML = '<tr><td colspan="11" class="loading">üîÑ Cargando usuarios...</td></tr>';
                statsDiv.innerHTML = '<div class="stat-card"><h3>‚è≥ Cargando...</h3><p>...</p></div>';
                
                console.log('üåê Haciendo fetch a usuarios.php...');
                const response = await fetch('usuarios.php');
                console.log('‚úÖ Respuesta recibida:', response);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üìä Datos recibidos:', data);
                
                if (data.success && data.usuarios) {
                    console.log('üë• Procesando usuarios:', data.usuarios.length);
                    mostrarUsuarios(data.usuarios);
                    mostrarEstadisticas(data.usuarios);
                } else {
                    throw new Error(data.message || 'Error en la respuesta del servidor');
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando usuarios:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="error">
                            ‚ùå Error cargando usuarios: ${error.message}
                        </td>
                    </tr>
                `;
                statsDiv.innerHTML = '<div class="stat-card"><h3>‚ùå Error</h3><p>Error cargando datos</p></div>';
            }
        }

        function mostrarUsuarios(usuarios) {
            console.log('üìã Mostrando usuarios en tabla...');
            const tbody = document.getElementById('cuerpo-tabla');
            
            if (!usuarios || usuarios.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="no-data">
                            <h3>üìù No hay usuarios registrados</h3>
                            <p>Los usuarios aparecer√°n aqu√≠ una vez que se registren.</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const html = usuarios.map(usuario => `
                <tr>
                    <td>${usuario.id}</td>
                    <td>${usuario.nombre_usuario}</td>
                    <td>${usuario.nombre_menor || 'N/A'}</td>
                    <td>${usuario.rango_edad || 'N/A'}</td>
                    <td>${usuario.nombre_padre_madre || 'N/A'}</td>
                    <td>${usuario.email || 'N/A'}</td>
                    <td>${usuario.telefono || 'N/A'}</td>
                    <td class="${formatearPuntos(usuario.puntos)}">${usuario.puntos || 0}</td>
                    <td class="${formatearRacha(usuario.racha_dias)}">${usuario.racha_dias || 0}</td>
                    <td class="${formatearUltimaSesion(usuario.ultima_sesion)}">${formatearUltimaSesion(usuario.ultima_sesion)}</td>
                    <td>${formatearFecha(usuario.fecha_registro)}</td>
                </tr>
            `).join('');
            
            tbody.innerHTML = html;
            console.log('‚úÖ Tabla actualizada con', usuarios.length, 'usuarios');
        }

        function mostrarEstadisticas(usuarios) {
            console.log('üìä Calculando estad√≠sticas...');
            const statsDiv = document.getElementById('estadisticas');
            
            if (!usuarios || usuarios.length === 0) {
                statsDiv.innerHTML = '<div class="stat-card"><h3>‚ùå Error</h3><p>No hay datos para mostrar</p></div>';
                return;
            }
            
            const totalUsuarios = usuarios.length;
            const totalPuntos = usuarios.reduce((sum, u) => sum + (u.puntos || 0), 0);
            const promedioPuntos = totalUsuarios > 0 ? Math.round(totalPuntos / totalUsuarios) : 0;
            const usuariosConRacha = usuarios.filter(u => (u.racha_dias || 0) > 0).length;
            const rachaMaxima = Math.max(...usuarios.map(u => u.racha_dias || 0));
            const usuariosActivos = usuarios.filter(u => u.ultima_sesion).length;
            
            const html = `
                <div class="stat-card">
                    <h3>üë• Total Usuarios</h3>
                    <p>${totalUsuarios}</p>
                </div>
                <div class="stat-card">
                    <h3>‚≠ê Total Puntos</h3>
                    <p>${totalPuntos}</p>
                </div>
                <div class="stat-card">
                    <h3>üìä Promedio Puntos</h3>
                    <p>${promedioPuntos}</p>
                </div>
                <div class="stat-card">
                    <h3>üî• Usuarios con Racha</h3>
                    <p>${usuariosConRacha}</p>
                </div>
                <div class="stat-card">
                    <h3>üèÜ Racha M√°xima</h3>
                    <p>${rachaMaxima} d√≠as</p>
                </div>
                <div class="stat-card">
                    <h3>‚úÖ Usuarios Activos</h3>
                    <p>${usuariosActivos}</p>
                </div>
            `;
            
            statsDiv.innerHTML = html;
            console.log('‚úÖ Estad√≠sticas calculadas y mostradas');
        }

        function formatearPuntos(puntos) {
            if (!puntos || puntos === 0) return 'puntos-cero';
            if (puntos < 10) return 'puntos-bajo';
            if (puntos < 50) return 'puntos-medio';
            return 'puntos-alto';
        }

        function formatearRacha(racha) {
            if (!racha || racha === 0) return 'racha-cero';
            if (racha < 3) return 'racha-baja';
            if (racha < 7) return 'racha-media';
            return 'racha-alta';
        }

        function formatearUltimaSesion(fecha) {
            if (!fecha) return 'Nunca';
            
            const fechaSesion = new Date(fecha);
            const hoy = new Date();
            const diferencia = hoy - fechaSesion;
            const dias = Math.floor(diferencia / (1000 * 60 * 60 * 24));
            
            if (dias === 0) return 'Hoy';
            if (dias === 1) return 'Ayer';
            if (dias < 7) return `${dias} d√≠as`;
            if (dias < 30) return `${dias} d√≠as`;
            return 'Antiguo';
        }

        function formatearFecha(fecha) {
            if (!fecha) return 'N/A';
            return new Date(fecha).toLocaleDateString('es-ES');
        }
    </script>
</body>
</html>






